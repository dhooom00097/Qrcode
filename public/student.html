<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø·Ø§Ù„Ø¨</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">ðŸ“š</div>
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø·Ø§Ù„Ø¨</h1>
                <p>Ø§Ù…Ø³Ø­ QR Code Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©</p>
            </div>

            <!-- QR Scanner -->
            <div id="qr-scanner-section" style="display: none;">
                <div id="qr-reader" style="width: 100%; margin-bottom: 20px;"></div>
                <button type="button" class="btn btn-secondary" onclick="stopScanner()">
                    <span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³Ø­</span>
                </button>
            </div>

            <!-- Manual Form -->
            <div id="manual-form-section">
                <button type="button" class="btn btn-primary" onclick="startScanner()" style="margin-bottom: 20px;">
                    <span>ðŸ“· Ù…Ø³Ø­ QR Code</span>
                </button>

                <div class="divider"><span>Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹</span></div>

                <form id="attendanceForm" class="login-form">
                    <div id="alert"></div>
                    <div class="form-group">
                        <label for="session-pin">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø© (PIN)</label>
                        <input type="text" id="session-pin" maxlength="6" required placeholder="000000">
                    </div>
                    <div class="form-group">
                        <label for="student-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="student-name" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                    </div>
                    <div class="form-group">
                        <label for="student-id">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</label>
                        <input type="text" id="student-id" required placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ">
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                    </button>
                </form>

                <div class="divider"><span>Ø£Ùˆ</span></div>
                <a href="index.html" class="btn btn-secondary"><span>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</span></a>
            </div>
        </div>
    </div>
    <script>
        // âœ… API_URL ÙŠØ£ØªÙŠ Ø§Ù„Ø¢Ù† Ù…Ù† Ù…Ù„Ù config.js
        let html5QrCode = null;
        let isScanning = false;

        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ PIN ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const pinFromURL = urlParams.get('pin');
            
            if (pinFromURL && pinFromURL.length === 6) {
                document.getElementById('session-pin').value = pinFromURL;
                showAlert('success', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©! Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù†');
                document.getElementById('student-name').focus();
            }
        });

        // QR Scanner Functions
        async function startScanner() {
            const scannerSection = document.getElementById('qr-scanner-section');
            const formSection = document.getElementById('manual-form-section');
            
            scannerSection.style.display = 'block';
            formSection.style.display = 'none';

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText) => {
                        onScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // Ignore scan errors
                    }
                );
                isScanning = true;
            } catch (err) {
                console.error('Error starting scanner:', err);
                showAlert('error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                stopScanner();
            }
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                } catch (err) {
                    console.error('Error stopping scanner:', err);
                }
            }

            document.getElementById('qr-scanner-section').style.display = 'none';
            document.getElementById('manual-form-section').style.display = 'block';
        }

        async function onScanSuccess(decodedText) {
            await stopScanner();
            
            // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† QR Code ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„
            try {
                const url = new URL(decodedText);
                const pin = url.searchParams.get('pin');
                if (pin && pin.length === 6) {
                    document.getElementById('session-pin').value = pin;
                    showAlert('success', 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­! Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù†');
                    setTimeout(() => {
                        document.getElementById('student-name').focus();
                    }, 500);
                    return;
                }
            } catch (e) {
                // Ù„ÙŠØ³ Ø±Ø§Ø¨Ø·ØŒ Ø¬Ø±Ø¨ ÙƒØ±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ
            }
            
            // Extract PIN from QR code (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚)
            const pin = decodedText.trim();
            
            if (pin && pin.length === 6) {
                document.getElementById('session-pin').value = pin;
                showAlert('success', 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­! Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù†');
                
                // Focus on name input
                setTimeout(() => {
                    document.getElementById('student-name').focus();
                }, 500);
            } else {
                showAlert('error', 'Ø±Ù…Ø² QR ØºÙŠØ± ØµØ­ÙŠØ­');
            }
        }

        // Form Submission
        document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pin = document.getElementById('session-pin').value;
            const name = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            const btn = document.getElementById('submitBtn');
            
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

            try {
                const location = await getLocation();
                const response = await fetch(`${API_URL}/attendance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionPin: pin, 
                        studentName: name, 
                        studentId: studentId, 
                        location: location 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
                    document.getElementById('attendanceForm').reset();
                } else {
                    showAlert('error', data.message);
                }
            } catch (error) {
                showAlert('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            } finally {
                btn.disabled = false;
                btn.querySelector('span').textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±';
            }
        });

        function getLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({ 
                            latitude: position.coords.latitude, 
                            longitude: position.coords.longitude 
                        }),
                        () => resolve(null)
                    );
                } else {
                    resolve(null);
                }
            });
        }

        function showAlert(type, message) {
            const alertDiv = document.getElementById('alert');
            const className = type === 'success' ? 'alert-success' : 'alert-error';
            alertDiv.innerHTML = `<div class="alert ${className}">${message}</div>`;
            
            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>