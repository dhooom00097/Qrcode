<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุณุฌูู ุญุถูุฑ ุทุงูุจ</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- โ ุฅุถุงูุฉ ููู ุงูุฅุนุฏุงุฏุงุช -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">๐</div>
                <h1>ุชุณุฌูู ุญุถูุฑ ุทุงูุจ</h1>
                <p>ุงูุณุญ QR Code ุฃู ุฃุฏุฎู ุฑูู ุงูุฌูุณุฉ</p>
            </div>

            <!-- QR Scanner -->
            <div id="qr-scanner-section" style="display: none;">
                <div id="qr-reader" style="width: 100%; margin-bottom: 20px;"></div>
                <button type="button" class="btn btn-secondary" onclick="stopScanner()">
                    <span>ุฅูุบุงุก ุงููุณุญ</span>
                </button>
            </div>

            <!-- Manual Form -->
            <div id="manual-form-section">
                <button type="button" class="btn btn-primary" onclick="startScanner()" style="margin-bottom: 20px;">
                    <span>๐ท ูุณุญ QR Code</span>
                </button>

                <div class="divider"><span>ุฃู ุฃุฏุฎู ุงูุจูุงูุงุช ูุฏููุงู</span></div>

                <form id="attendanceForm" class="login-form">
                    <div id="alert"></div>
                    <div class="form-group">
                        <label for="session-pin">ุฑูู ุงูุฌูุณุฉ (PIN)</label>
                        <input type="text" id="session-pin" maxlength="6" required placeholder="000000">
                    </div>
                    <div class="form-group">
                        <label for="student-name">ุงูุงุณู ุงููุงูู</label>
                        <input type="text" id="student-name" required placeholder="ุฃุฏุฎู ุงุณูู ุงููุงูู">
                    </div>
                    <div class="form-group">
                        <label for="student-id">ุงูุฑูู ุงูุฌุงูุนู</label>
                        <input type="text" id="student-id" required placeholder="ุฃุฏุฎู ุฑููู ุงูุฌุงูุนู">
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span>ุชุณุฌูู ุงูุญุถูุฑ</span>
                    </button>
                </form>

                <div class="divider"><span>ุฃู</span></div>
                <a href="index.html" class="btn btn-secondary"><span>ุชุณุฌูู ุฏุฎูู ุงููุนูู</span></a>
            </div>
        </div>
    </div>
    <script>
        // โ API_URL ูุฃุชู ุงูุขู ูู ููู config.js
        let html5QrCode = null;
        let isScanning = false;

        // โ ุงูุชุญูู ูู ูุฌูุฏ PIN ูู ุงูุฑุงุจุท ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const pinFromURL = urlParams.get('pin');
            
            if (pinFromURL && pinFromURL.length === 6) {
                document.getElementById('session-pin').value = pinFromURL;
                showAlert('success', 'ุชู ุชุญููู ุฑูู ุงูุฌูุณุฉ! ุฃุฏุฎู ุจูุงูุงุชู ุงูุขู');
                document.getElementById('student-name').focus();
            }
        });

        // QR Scanner Functions
        async function startScanner() {
            const scannerSection = document.getElementById('qr-scanner-section');
            const formSection = document.getElementById('manual-form-section');
            
            scannerSection.style.display = 'block';
            formSection.style.display = 'none';

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText) => {
                        onScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // Ignore scan errors
                    }
                );
                isScanning = true;
            } catch (err) {
                console.error('Error starting scanner:', err);
                showAlert('error', 'ุฎุทุฃ ูู ุชุดุบูู ุงููุงููุฑุง. ุชุฃูุฏ ูู ุงูุณูุงุญ ูููุตูู ุฅูู ุงููุงููุฑุง');
                stopScanner();
            }
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                } catch (err) {
                    console.error('Error stopping scanner:', err);
                }
            }

            document.getElementById('qr-scanner-section').style.display = 'none';
            document.getElementById('manual-form-section').style.display = 'block';
        }

        async function onScanSuccess(decodedText) {
            await stopScanner();
            
            // โ ุงูุชุญูู ุฅุฐุง ูุงู QR Code ูุญุชูู ุนูู ุฑุงุจุท ูุงูู
            try {
                const url = new URL(decodedText);
                const pin = url.searchParams.get('pin');
                if (pin && pin.length === 6) {
                    document.getElementById('session-pin').value = pin;
                    showAlert('success', 'ุชู ูุณุญ ุงูุฑูุฒ ุจูุฌุงุญ! ุฃุฏุฎู ุจูุงูุงุชู ุงูุขู');
                    setTimeout(() => {
                        document.getElementById('student-name').focus();
                    }, 500);
                    return;
                }
            } catch (e) {
                // ููุณ ุฑุงุจุทุ ุฌุฑุจ ูุฑูู ุนุงุฏู
            }
            
            // Extract PIN from QR code (ุงูุทุฑููุฉ ุงููุฏููุฉ ููุชูุงูู)
            const pin = decodedText.trim();
            
            if (pin && pin.length === 6) {
                document.getElementById('session-pin').value = pin;
                showAlert('success', 'ุชู ูุณุญ ุงูุฑูุฒ ุจูุฌุงุญ! ุฃุฏุฎู ุจูุงูุงุชู ุงูุขู');
                
                // Focus on name input
                setTimeout(() => {
                    document.getElementById('student-name').focus();
                }, 500);
            } else {
                showAlert('error', 'ุฑูุฒ QR ุบูุฑ ุตุญูุญ');
            }
        }

        // Form Submission
        document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pin = document.getElementById('session-pin').value;
            const name = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            const btn = document.getElementById('submitBtn');
            
            btn.disabled = true;
            btn.querySelector('span').textContent = 'ุฌุงุฑู ุงูุชุณุฌูู...';

            try {
                const location = await getLocation();
                
                // โ ุงูุชุญูู ูู ุงููููุน - ุฅุฌุจุงุฑู!
                if (!location) {
                    showAlert('error', 'โ ูุฌุจ ุงูุณูุงุญ ุจุงููุตูู ูููููุน ูุชุณุฌูู ุงูุญุถูุฑ');
                    btn.disabled = false;
                    btn.querySelector('span').textContent = 'ุชุณุฌูู ุงูุญุถูุฑ';
                    return;
                }
                
                const response = await fetch(`${API_URL}/attendance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionPin: pin, 
                        studentName: name, 
                        studentId: studentId, 
                        location: location 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'โ ุชู ุชุณุฌูู ุญุถูุฑู ุจูุฌุงุญ!');
                    document.getElementById('attendanceForm').reset();
                } else {
                    showAlert('error', data.message);
                }
            } catch (error) {
                showAlert('error', 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
            } finally {
                btn.disabled = false;
                btn.querySelector('span').textContent = 'ุชุณุฌูู ุงูุญุถูุฑ';
            }
        });

        function getLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    // ุฅุนุทุงุก timeout 5 ุซูุงูู ููุท
                    const timeoutId = setTimeout(() => {
                        resolve(null);
                    }, 5000);
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeoutId);
                            resolve({ 
                                latitude: position.coords.latitude, 
                                longitude: position.coords.longitude 
                            });
                        },
                        () => {
                            clearTimeout(timeoutId);
                            resolve(null); // ุฑูุถ ุงููููุน = ุชุณุฌูู ุจุฏูู ูููุน
                        }
                    );
                } else {
                    resolve(null);
                }
            });
        }

        function showAlert(type, message) {
            const alertDiv = document.getElementById('alert');
            const className = type === 'success' ? 'alert-success' : 'alert-error';
            alertDiv.innerHTML = `<div class="alert ${className}">${message}</div>`;
            
            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>