<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard">
    <div class="dashboard-container">
        <nav class="navbar">
            <div class="navbar-brand">
                <div class="logo" style="width: 50px; height: 50px; font-size: 24px;">âš™ï¸</div>
                <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            </div>
            <div class="user-menu">
                <a href="dashboard.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px; text-decoration: none;">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </a>
            </div>
        </nav>

        <!-- ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
        <div class="card">
            <div class="card-header">
                <h3>ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
            </div>
            
            <div id="password-alert"></div>

            <form id="changePasswordForm" style="max-width: 500px;">
                <div class="form-group">
                    <label for="oldPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                    <div class="password-input">
                        <input type="password" id="oldPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
                        <button type="button" class="toggle-password" onclick="togglePassword('oldPassword')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <div class="password-input">
                        <input type="password" id="newPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" minlength="6">
                        <button type="button" class="toggle-password" onclick="togglePassword('newPassword')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <small style="color: var(--gray-500);">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <div class="password-input">
                        <input type="password" id="confirmPassword" required placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                        <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                    <span>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</span>
                </button>
            </form>
        </div>

        <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
        <div class="card">
            <div class="card-header">
                <h3>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
            </div>
            
            <div id="user-alert"></div>

            <form id="addUserForm" style="max-width: 500px;">
                <div class="form-group">
                    <label for="newUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="newUsername" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                </div>

                <div class="form-group">
                    <label for="newUserName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="newUserName" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>

                <div class="form-group">
                    <label for="newUserPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                    <div class="password-input">
                        <input type="password" id="newUserPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" minlength="6">
                        <button type="button" class="toggle-password" onclick="togglePassword('newUserPassword')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="userRole">Ø§Ù„Ø¯ÙˆØ±</label>
                    <select id="userRole" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 12px;">
                        <option value="teacher">Ù…Ø¹Ù„Ù…</option>
                        <option value="admin">Ù…Ø³Ø¤ÙˆÙ„</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" id="addUserBtn">
                    <span>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                </button>
            </form>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="card">
            <div class="card-header">
                <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            </div>
            
            <div id="settings-alert"></div>

            <form id="settingsForm" style="max-width: 500px;">
                <div class="form-group">
                    <label for="locationRadius">Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Ù…ØªØ±)</label>
                    <input type="number" id="locationRadius" min="10" max="1000" value="100">
                    <small style="color: var(--gray-500);">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù‚ØµÙˆÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø©</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="requireLocation" checked style="width: auto;">
                        <span>Ø¥Ù„Ø²Ø§Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="preventDuplicate" checked style="width: auto;">
                        <span>Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø±</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary" id="settingsBtn">
                    <span>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let currentUser = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(user);
            loadSettings();
        });

        // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('changePasswordBtn');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
            if (newPassword !== confirmPassword) {
                showAlert('password', 'error', 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('password', 'error', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            btn.disabled = true;
            btn.querySelector('span').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØºÙŠÙŠØ±...';

            try {
                const response = await fetch(`${API_URL}/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        oldPassword: oldPassword,
                        newPassword: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('password', 'success', 'âœ“ ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­!');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showAlert('password', 'error', data.message);
                }
            } catch (error) {
                showAlert('password', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            } finally {
                btn.disabled = false;
                btn.querySelector('span').textContent = 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±';
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const name = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('userRole').value;
            const btn = document.getElementById('addUserBtn');

            btn.disabled = true;
            btn.querySelector('span').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, name, password, role })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('user', 'success', `âœ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${data.user.username} Ø¨Ù†Ø¬Ø§Ø­!`);
                    document.getElementById('addUserForm').reset();
                } else {
                    showAlert('user', 'error', data.message);
                }
            } catch (error) {
                showAlert('user', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            } finally {
                btn.disabled = false;
                btn.querySelector('span').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            }
        });

        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                locationRadius: parseInt(document.getElementById('locationRadius').value),
                requireLocation: document.getElementById('requireLocation').checked,
                preventDuplicate: document.getElementById('preventDuplicate').checked
            };

            const btn = document.getElementById('settingsBtn');
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                const response = await fetch(`${API_URL}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('settings', 'success', 'âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                }
            } catch (error) {
                showAlert('settings', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            } finally {
                btn.disabled = false;
                btn.querySelector('span').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}/settings`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('locationRadius').value = data.settings.locationRadius;
                    document.getElementById('requireLocation').checked = data.settings.requireLocation;
                    document.getElementById('preventDuplicate').checked = data.settings.preventDuplicate;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function showAlert(section, type, message) {
            const alertDiv = document.getElementById(`${section}-alert`);
            const className = type === 'success' ? 'alert-success' : 'alert-error';
            alertDiv.innerHTML = `<div class="alert ${className}">${message}</div>`;
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }
    </script>
</body>
</html>