<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard">
    <div class="dashboard-container">
        <nav class="navbar">
            <div class="navbar-brand">
                <div class="logo" style="width: 50px; height: 50px; font-size: 24px;">ğŸ“‹</div>
                <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name" id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                    <div class="user-role" id="userRole">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                </div>
                <a href="settings.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px; text-decoration: none; margin-left: 10px;">
                    âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </a>
                <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </nav>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">ğŸ“š</div>
                <div class="stat-content">
                    <h3 id="totalSessions">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success">âœ“</div>
                <div class="stat-content">
                    <h3 id="totalAttendance">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">â±ï¸</div>
                <div class="stat-content">
                    <h3 id="activeSessions">0</h3>
                    <p>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h3>
                <button class="btn btn-primary" onclick="showCreateSessionModal()" style="width: auto; padding: 12px 24px;">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© +
                </button>
            </div>
            <div class="sessions-grid" id="sessionsGrid">
                <p style="text-align: center; color: var(--gray-500); padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
    </div>

    <!-- Modal Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© -->
    <div id="createSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button class="modal-close" onclick="closeModal('createSessionModal')">Ã—</button>
            </div>
            <form id="createSessionForm">
                <div class="form-group">
                    <label for="sessionName">Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©</label>
                    <input type="text" id="sessionName" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">
                </div>
                <button type="submit" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
            </form>
        </div>
    </div>

    <!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© -->
    <div id="sessionDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="sessionDetailsTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
                <button class="modal-close" onclick="closeModal('sessionDetailsModal')">Ã—</button>
            </div>
            
            <div class="qr-container">
                <h4>Ø±Ù…Ø² QR Ù„Ù„Ø¬Ù„Ø³Ø©</h4>
                <img id="sessionQR" src="" alt="QR Code" style="max-width: 250px;">
                <div class="pin-display">
                    <p style="margin: 0; opacity: 0.9;">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø© (PIN)</p>
                    <h2 id="sessionPIN" style="font-family: monospace;">------</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.8;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="downloadQR()" style="width: auto; padding: 10px 20px;">
                        ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ù…Ø²
                    </button>
                    <button class="btn btn-secondary" onclick="toggleSessionStatus()" id="toggleStatusBtn" style="width: auto; padding: 10px 20px;">
                        Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©
                    </button>
                </div>
            </div>

            <div class="location-edit" id="sessionLocationEdit">
                <h4>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</h4>
                <div class="location-inputs">
                    <div class="form-group">
                        <label for="editLat">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
                        <input type="number" id="editLat" step="0.000001" placeholder="24.774265">
                    </div>
                    <div class="form-group">
                        <label for="editLng">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label>
                        <input type="number" id="editLng" step="0.000001" placeholder="46.738586">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="updateSessionLocation()" style="margin-top: 10px;">
                    ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>

            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (<span id="attendanceCount">0</span>)</h4>
                    <button class="btn btn-secondary" onclick="exportToExcel()" style="width: auto; padding: 8px 16px; font-size: 14px;">
                        ØªØµØ¯ÙŠØ± Excel
                    </button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</th>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--gray-500);">
                                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div id="editLocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <button class="modal-close" onclick="closeModal('editLocationModal')">Ã—</button>
            </div>
            <form id="editLocationForm">
                <div class="form-group">
                    <label for="studentLat">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
                    <input type="number" id="studentLat" step="0.000001" required>
                </div>
                <div class="form-group">
                    <label for="studentLng">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label>
                    <input type="number" id="studentLng" step="0.000001" required>
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let currentUser = null;
        let sessions = [];
        let currentSession = null;
        let currentAttendance = [];
        let editingAttendanceId = null;
        let updateInterval = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(user);
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            loadStats();
            loadSessions();
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalSessions').textContent = data.stats.totalSessions;
                    document.getElementById('totalAttendance').textContent = data.stats.totalAttendance;
                    document.getElementById('activeSessions').textContent = data.stats.activeSessions;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/sessions`);
                const data = await response.json();
                if (data.success) {
                    sessions = data.sessions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    displaySessions();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function displaySessions() {
            const grid = document.getElementById('sessionsGrid');
            if (sessions.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©!</p>';
                return;
            }

            grid.innerHTML = sessions.map(session => `
                <div class="session-card" onclick="viewSession(${session.id})">
                    <div class="session-header">
                        <div class="session-title">${session.sessionName || 'Ø¬Ù„Ø³Ø©'}</div>
                        <span class="session-status ${session.isOpen ? 'status-open' : 'status-closed'}">
                            ${session.isOpen ? 'Ù…ÙØªÙˆØ­Ø©' : 'Ù…ØºÙ„Ù‚Ø©'}
                        </span>
                    </div>
                    <div class="session-info">
                        <div>ğŸ”¢ PIN: ${session.pin}</div>
                        <div>ğŸ‘¥ Ø§Ù„Ø­Ø¶ÙˆØ±: ${session.attendanceCount || 0}</div>
                        <div>ğŸ“… ${new Date(session.createdAt).toLocaleDateString('ar-SA')}</div>
                        <div>â° ${new Date(session.createdAt).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    <div class="session-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-primary btn-sm" onclick="viewSession(${session.id})">
                            Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="deleteSession(${session.id})">
                            Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateSessionModal() {
            document.getElementById('createSessionModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.getElementById('createSessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sessionName = document.getElementById('sessionName').value;

            try {
                const location = await getLocation();
                const response = await fetch(`${API_URL}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teacherId: currentUser.id,
                        sessionName: sessionName,
                        location: location
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('createSessionModal');
                    document.getElementById('createSessionForm').reset();
                    loadSessions();
                    loadStats();
                    viewSession(data.session.id);
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©');
            }
        });

        async function viewSession(sessionId) {
            try {
                const response = await fetch(`${API_URL}/sessions/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentSession = data.session;
                    document.getElementById('sessionDetailsTitle').textContent = currentSession.sessionName || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©';
                    document.getElementById('sessionPIN').textContent = currentSession.pin;
                    
                    // ØªØ­Ù…ÙŠÙ„ QR Code
                    const qrResponse = await fetch(`${API_URL}/qrcode/${currentSession.pin}`);
                    const qrData = await qrResponse.json();
                    if (qrData.success) {
                        document.getElementById('sessionQR').src = qrData.qrCode;
                    }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    if (currentSession.location) {
                        document.getElementById('editLat').value = currentSession.location.latitude;
                        document.getElementById('editLng').value = currentSession.location.longitude;
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø©
                    const toggleBtn = document.getElementById('toggleStatusBtn');
                    toggleBtn.textContent = currentSession.isOpen ? 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©' : 'ÙØªØ­ Ø§Ù„Ø¬Ù„Ø³Ø©';
                    toggleBtn.className = currentSession.isOpen ? 'btn btn-secondary' : 'btn btn-primary';

                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
                    await loadAttendance(sessionId);
                    
                    document.getElementById('sessionDetailsModal').classList.add('active');

                    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    clearInterval(updateInterval);
                    updateInterval = setInterval(() => loadAttendance(sessionId), 3000);
                }
            } catch (error) {
                console.error('Error viewing session:', error);
            }
        }

        async function loadAttendance(sessionId) {
            try {
                const response = await fetch(`${API_URL}/attendance/session/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentAttendance = data.attendance;
                    displayAttendance();
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        function displayAttendance() {
            const tbody = document.getElementById('attendanceTableBody');
            document.getElementById('attendanceCount').textContent = currentAttendance.length;

            if (currentAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray-500);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                return;
            }

            tbody.innerHTML = currentAttendance.map((record, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${record.studentName}</td>
                    <td>${record.studentId}</td>
                    <td>${new Date(record.timestamp).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}</td>
                    <td>
                        ${record.location ? 
                            `<span class="badge location-badge">ğŸ“ ${record.location.latitude.toFixed(4)}, ${record.location.longitude.toFixed(4)}</span>` : 
                            '<span class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>'
                        }
                        ${record.locationEdited ? '<span style="color: var(--warning); font-size: 12px;">âœï¸</span>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editLocation(${record.id})" style="padding: 4px 10px; font-size: 12px;">
                            ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function editLocation(attendanceId) {
            const record = currentAttendance.find(a => a.id === attendanceId);
            if (record && record.location) {
                editingAttendanceId = attendanceId;
                document.getElementById('studentLat').value = record.location.latitude;
                document.getElementById('studentLng').value = record.location.longitude;
                document.getElementById('editLocationModal').classList.add('active');
            }
        }

        document.getElementById('editLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lat = parseFloat(document.getElementById('studentLat').value);
            const lng = parseFloat(document.getElementById('studentLng').value);

            try {
                const response = await fetch(`${API_URL}/attendance/${editingAttendanceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { latitude: lat, longitude: lng }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('editLocationModal');
                    loadAttendance(currentSession.id);
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹');
            }
        });

        async function updateSessionLocation() {
            const lat = parseFloat(document.getElementById('editLat').value);
            const lng = parseFloat(document.getElementById('editLng').value);

            if (!lat || !lng) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/sessions/${currentSession.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { latitude: lat, longitude: lng }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    currentSession = data.session;
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹');
            }
        }

        async function toggleSessionStatus() {
            try {
                const response = await fetch(`${API_URL}/sessions/${currentSession.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isOpen: !currentSession.isOpen })
                });

                const data = await response.json();
                if (data.success) {
                    currentSession = data.session;
                    const toggleBtn = document.getElementById('toggleStatusBtn');
                    toggleBtn.textContent = currentSession.isOpen ? 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©' : 'ÙØªØ­ Ø§Ù„Ø¬Ù„Ø³Ø©';
                    toggleBtn.className = currentSession.isOpen ? 'btn btn-secondary' : 'btn btn-primary';
                    loadSessions();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')) return;

            try {
                const response = await fetch(`${API_URL}/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadSessions();
                    loadStats();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©');
            }
        }

        function downloadQR() {
            const img = document.getElementById('sessionQR');
            const link = document.createElement('a');
            link.download = `qr-code-${currentSession.pin}.png`;
            link.href = img.src;
            link.click();
        }

        function exportToExcel() {
            if (currentAttendance.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            let csv = '\ufeffØ§Ù„Ø§Ø³Ù…,Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ,Ø§Ù„ÙˆÙ‚Øª,Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„\n';
            
            currentAttendance.forEach(record => {
                const time = new Date(record.timestamp).toLocaleString('ar-SA');
                const lat = record.location ? record.location.latitude : '-';
                const lng = record.location ? record.location.longitude : '-';
                csv += `${record.studentName},${record.studentId},${time},${lat},${lng}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `attendance-${currentSession.pin}.csv`;
            link.click();
        }

        function getLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }),
                        () => resolve(null)
                    );
                } else {
                    resolve(null);
                }
            });
        }

        function logout() {
            localStorage.removeItem('user');
            clearInterval(updateInterval);
            window.location.href = 'index.html';
        }

        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ modal
        document.getElementById('sessionDetailsModal').addEventListener('click', (e) => {
            if (e.target.id === 'sessionDetailsModal') {
                clearInterval(updateInterval);
            }
        });

        window.addEventListener('beforeunload', () => {
            clearInterval(updateInterval);
        });
    </script>
</body>
</html>